{
  reset();
  LocalBroadcastManager.getInstance(this).registerReceiver(mMessageReceiver,new IntentFilter("mizuu-stop-offline-download"));
  mContext=getApplicationContext();
  file=intent.getExtras().getString(FILEPATH);
  type=intent.getExtras().getInt(TYPE);
  mNotificationManager=(NotificationManager)getSystemService(Context.NOTIFICATION_SERVICE);
  Intent notificationIntent=new Intent(this,CancelOfflineDownload.class);
  notificationIntent.setAction(Intent.ACTION_MAIN);
  notificationIntent.addCategory(Intent.CATEGORY_LAUNCHER);
  contentIntent=PendingIntent.getActivity(this,0,notificationIntent,0);
  builder=new NotificationCompat.Builder(mContext);
  builder.setOngoing(true);
  builder.setOnlyAlertOnce(true);
  builder.setSmallIcon(android.R.drawable.stat_sys_download);
  builder.setContentIntent(contentIntent);
  String message=getString(R.string.downloadingMovie);
  if (type == MizLib.TYPE_SHOWS)   message=getString(R.string.downloadingEpisode);
  builder.setTicker(message);
  builder.setContentTitle(message);
  builder.setContentText(getContentText());
  builder.setLargeIcon(MizLib.getNotificationImageThumbnail(mContext,intent.getExtras().getString("thumb")));
  builder.addAction(R.drawable.remove,getString(android.R.string.cancel),contentIntent);
  boolean exists=checkIfNetworkFileExists();
  if (!exists) {
    mHandler.post(new Runnable(){
      @Override public void run(){
        Toast.makeText(mContext,R.string.unavailable_file,Toast.LENGTH_LONG).show();
      }
    }
);
    stopSelf();
    return;
  }
  boolean ignoreSizeCheck=PreferenceManager.getDefaultSharedPreferences(mContext).getBoolean(IGNORE_FILESIZE_CHECK,false);
  if (!ignoreSizeCheck) {
    boolean sizeOK=checkFilesize();
    if (!sizeOK) {
      mHandler.post(new Runnable(){
        @Override public void run(){
          Toast.makeText(mContext,R.string.not_enough_space,Toast.LENGTH_LONG).show();
        }
      }
);
      stopSelf();
      return;
    }
  }
  exists=checkIfLocalCopyExists();
  if (exists) {
    stopSelf();
    return;
  }
  mHandler.post(new Runnable(){
    @Override public void run(){
      Toast.makeText(mContext,R.string.starting_download,Toast.LENGTH_SHORT).show();
    }
  }
);
  updateNotification();
  startForeground(NOTIFICATION_ID,mNotification);
  boolean success=beginTransfer();
  if (!success) {
    if (file.startsWith("http"))     MizLib.getOfflineFile(mContext,file).delete();
 else     MizLib.getOfflineFile(mContext,smb.getCanonicalPath()).delete();
  }
}
